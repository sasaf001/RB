import React, { useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";

const API_BASE = "https://demo-green-puma-81717.okta.com/api/v1/users";
const AUTH_HEADER = { Authorization: "SSWS 00pKU38MmlaAOr-_c7UDha06cUcl0krxY76vLPVtwh" };

export default function UserManagement() {
  const [email, setEmail] = useState("");
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const fetchUserData = async () => {
    setLoading(true);
    setError("");
    try {
      const response = await fetch(`${API_BASE}/${encodeURIComponent(email)}`, { headers: AUTH_HEADER });
      if (!response.ok) throw new Error("Benutzer nicht gefunden");
      const data = await response.json();
      setUser(data.profile);
    } catch (err) {
      setError(err.message);
      setUser(null);
    }
    setLoading(false);
  };

  const updateUserData = async () => {
    setLoading(true);
    try {
      await fetch(`${API_BASE}/${encodeURIComponent(email)}`, {
        method: "POST",
        headers: { ...AUTH_HEADER, "Content-Type": "application/json" },
        body: JSON.stringify({ profile: user }),
      });
      alert("Benutzerdaten aktualisiert!");
    } catch {
      alert("Fehler beim Aktualisieren");
    }
    setLoading(false);
  };

  const registerUser = async () => {
    setLoading(true);
    try {
      const response = await fetch(`${API_BASE}?activate=true`, {
        method: "POST",
        headers: { ...AUTH_HEADER, "Content-Type": "application/json" },
        body: JSON.stringify({ profile: user }),
      });
      if (!response.ok) throw new Error("Fehler bei der Registrierung");
      alert("Benutzer erfolgreich registriert!");
    } catch (err) {
      alert(err.message);
    }
    setLoading(false);
  };

  return (
    <div className="p-6 max-w-2xl mx-auto">
      <Tabs defaultValue="search" className="w-full">
        <TabsList>
          <TabsTrigger value="search">Benutzersuche</TabsTrigger>
          <TabsTrigger value="register">Registrierung</TabsTrigger>
        </TabsList>

        {/* Benutzer suchen */}
        <TabsContent value="search">
          <Card>
            <CardContent className="p-4 space-y-4">
              <Input placeholder="E-Mail eingeben" value={email} onChange={(e) => setEmail(e.target.value)} />
              <Button onClick={fetchUserData} disabled={loading}>
                {loading ? "Lade..." : "Benutzerdaten abrufen"}
              </Button>
              {error && <p className="text-red-500">{error}</p>}
              {user && (
                <div className="space-y-2">
                  <Input placeholder="Vorname" value={user.firstName} onChange={(e) => setUser({ ...user, firstName: e.target.value })} />
                  <Input placeholder="Nachname" value={user.lastName} onChange={(e) => setUser({ ...user, lastName: e.target.value })} />
                  <Button onClick={updateUserData} disabled={loading}>Speichern</Button>
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        {/* Benutzer registrieren */}
        <TabsContent value="register">
          <Card>
            <CardContent className="p-4 space-y-4">
              <Input placeholder="Vorname" onChange={(e) => setUser({ ...user, firstName: e.target.value })} required />
              <Input placeholder="Nachname" onChange={(e) => setUser({ ...user, lastName: e.target.value })} required />
              <Input placeholder="E-Mail" onChange={(e) => setUser({ ...user, email: e.target.value })} required />
              <Button onClick={registerUser} disabled={loading}>Registrieren</Button>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
}
